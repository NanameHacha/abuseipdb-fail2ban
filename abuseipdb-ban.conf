[Definition]
actionstart = iptables -N f2b-abuseipdb-ssh
              iptables -A f2b-abuseipdb-ssh -j RETURN
              iptables -I INPUT -p tcp --dport 22 -j f2b-abuseipdb-ssh

actionstop = iptables -D INPUT -p tcp --dport 22 -j f2b-abuseipdb-ssh
             iptables -F f2b-abuseipdb-ssh
             iptables -X f2b-abuseipdb-ssh

actioncheck = 

actionban = IP="<ip>"
            CONFIDENCE="80"
            RESPONSE=$(curl -s -f -G "https://api.abuseipdb.com/api/v2/check" \
              --data-urlencode "ipAddress=$IP" \
              -H "Key: <_apikey>" \
              -H "Accept: application/json" 2>/dev/null || echo '{}')
            
            SCORE=$(echo "$RESPONSE" | grep -o '"abuseConfidenceScore":[0-9]*' | cut -d: -f2)
            
            if [ -n "$SCORE" ] && [ "$SCORE" -ge "$CONFIDENCE" ]; then
              iptables -I f2b-abuseipdb-ssh 1 -s <ip> -j REJECT
              echo "$(date '+%%Y-%%m-%%d %%H:%%M:%%S') - Banned <ip> via AbuseIPDB (Score: $SCORE)" >> /var/log/fail2ban-abuseipdb.log
            fi

actionunban = iptables -D f2b-abuseipdb-ssh -s <ip> -j REJECT 2>/dev/null || true

[Init]
name = abuseipdb-ssh
_apikey =
